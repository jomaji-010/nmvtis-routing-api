<?xml version="1.0" encoding="UTF-8"?>

<mule xmlns:ee="http://www.mulesoft.org/schema/mule/ee/core" xmlns:http="http://www.mulesoft.org/schema/mule/http"
	xmlns:os="http://www.mulesoft.org/schema/mule/os"
	xmlns="http://www.mulesoft.org/schema/mule/core" xmlns:doc="http://www.mulesoft.org/schema/mule/documentation" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://www.mulesoft.org/schema/mule/core http://www.mulesoft.org/schema/mule/core/current/mule.xsd
http://www.mulesoft.org/schema/mule/os http://www.mulesoft.org/schema/mule/os/current/mule-os.xsd
http://www.mulesoft.org/schema/mule/http http://www.mulesoft.org/schema/mule/http/current/mule-http.xsd
http://www.mulesoft.org/schema/mule/ee/core http://www.mulesoft.org/schema/mule/ee/core/current/mule-ee.xsd">
	<flow name="validate-auth-token-aamva-flow" doc:id="9be7701b-de51-4f1c-8d0c-9ecf753fd2b6" >
		<ee:transform doc:name="input-authToken" doc:id="19ce34fd-d758-4436-9f0a-1ad961dda7c1" >
			<ee:message >
			</ee:message>
			<ee:variables >
				<ee:set-variable variableName="authorization" ><![CDATA[%dw 2.0
output application/java
---
(attributes.headers.Authorization splitBy(" "))[1]]]></ee:set-variable>
			</ee:variables>
		</ee:transform>
		<ee:transform doc:name="set-authToken-to-validate" doc:id="cfce0650-106f-45e3-a2d6-92a3f222bf36">
			<ee:message>
				<ee:set-payload><![CDATA[%dw 2.0
output application/json
---
vars.authorization as String]]></ee:set-payload>
			</ee:message>
		</ee:transform>
		<http:request method="POST" doc:name="validate-authToken" doc:id="e1e0649f-8739-4fef-9336-1c7be203be69" config-ref="HTTPS_AAMVA_Verify_Token_Request" path="${aamva.verifytoken.path}" />
		<ee:transform doc:name="output-Validation Response" doc:id="c3cc13c1-18a9-4df9-ad95-ebce2aeaf5fb" >
			<ee:message >
				<ee:set-payload ><![CDATA[%dw 2.0
output application/json
---
payload]]></ee:set-payload>
			</ee:message>
		</ee:transform>
		<error-handler >
			<on-error-propagate enableNotifications="true" logException="true" doc:name="On Error Propagate" doc:id="7dc2af5c-627c-4ee6-b9a1-096228845685" type="ANY">
				<ee:transform doc:name="Transform Message" doc:id="a44e9c99-a6fd-47b1-bc7f-2ca09619c49e" >
					<ee:message >
						<ee:set-payload ><![CDATA[%dw 2.0
output application/json
---
{
	code : 500,
	message : error.description
}]]></ee:set-payload>
					</ee:message>
				</ee:transform>
			</on-error-propagate>
		</error-handler>
	</flow>
</mule>
